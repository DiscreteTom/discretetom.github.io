---
title: Redis相关知识点的总结
description: RDB/AOF持久化、缓存雪崩、穿透、击穿
tags:
  - Redis
---

## Redis概述

- 内存k-v数据库，使用C语言编写，非常快，但是断电后内存中数据丢失（可以通过持久化数据避免数据丢失）
- 通常用来做SQL数据库的缓存。也可以单独拿来做内存数据库，或者用来生成分布式唯一主键、实现分布式锁、队列等
- 主进程是单线程的，所有数据操作都不会被并行处理。在执行持久化等操作的时候才会fork出子进程
- 可以使用管道(pipe)实现简单的事务。也可以用来执行批量操作，提升操作速度

## 持久化方式

### RDB

- 默认位置：在启动redis服务端的目录中的`dump.rdb`
- 使用二进制的形式保存内存中保存的数据
- 触发方式
  - 手动触发
    - `SAVE`使用主进程进行持久化，会block操作
    - `BGSAVE`使用fork创建子进程进行持久化，主进程不受影响
  - **在Redis中**执行`SHUTDOWN`时，如果没有配置AOF，则会触发持久化
  - 执行`FLUSHALL`时会触发，把RDB文件清空
  - 根据配置文件定时触发
    - 默认值
      - `save 900 1` - 900秒内有1次写入时，保存
      - `save 300 10` - 300秒内有10次写入时，保存
      - `save 60 10000` - 60秒内有10000次写入时，保存
    - 如果开了主从配置，通常会关闭主节点的定时保存功能

### AOF

Append-Only File

有点类似于时序数据库或MySQL的binlog。AOF文件会把写操作以**字符串**保存在文件中

- 触发机制：编辑配置文件
  - `no` - 由操作系统触发，无法保证数据的持久化
  - `always` - 记录每一个写操作
  - `everysec` - 每秒保存一次。默认值。**推荐**
- AOF重写：AOF文件过大时，合并AOF中的信息以减少AOF文件
  - 如果使用的redis版本较新，AOF文件可能会使用混合存储模式，使用RDB格式保存部分数据以进一步减少AOF文件大小(4.0版本引入混合存储，5.0版本默认使用混合存储)

使用默认配置的AOF，数据最多只会丢失2s，比RDB丢失的数据更少。

### 数据恢复

启动redis时，如果启动了AOF且目录下存在AOF文件则加载AOF文件。如果没有AOF文件且启动了RDB则加载RDB文件。如果都没有，则以空内容启动

## Redis常见问题

### 缓存雪崩

大量缓存数据在同一时间失效，导致大量查询请求同时直接打到数据库

解决方案：

- 使用随机TTL
- 不使用TTL
- 使用定时任务刷TTL

### 缓存穿透

使用不合法参数，使缓存必定miss，从而直接把压力施加到数据库。比如数据库里面的id都是大于0的，使用小于0的id在redis里面查询必定会导致缓存miss，从而直接在数据库查询

解决方案：

- 应用层参数验证、WAF
- 封锁恶意用户IP
- 使用布隆过滤器(Bloom Filter)

### 缓存击穿

热点数据过期，会有大量请求直接打到数据库。比如电商秒杀场景

解决方案：

- 不使用TTL
- 如果是单体应用，可以使用分布式锁
  - 多个线程争夺一个互斥锁。拿到锁的线程负责访问数据库并更新到Redis，其他线程短暂sleep后重新访问Redis而不是数据库。这样就只会有一个请求打到数据库


## 参考

- [Redis中两种持久化机制RDB和AOF](https://bilibili.com/video/BV1U54y1C7rm)
- [什么是Redis缓存雪崩、穿透、击穿](https://bilibili.com/video/BV1f5411b7ux)


