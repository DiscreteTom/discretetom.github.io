---
title: 51单片机
---

## 前言

本文是[此视频](https://www.bilibili.com/video/BV1Mb411e7re)的笔记

## 简介

- 51 单片机系列之所以叫 51 单片机，是因为指令集兼容 intel 8051 指令集
- 8 位处理器
- 自身的 ROM 只能存储程序。如果要保存数据掉电不丢失，需要额外的芯片

## 最小系统

单片机只能实现运算和 IO，所以还需要其他芯片和模块，才能组成一个最简单的计算机

以下组件是必备的：

- 电源
  - 滤波电容，用来稳定电源供给
- 时钟
  - 晶振
    - 有些单片机可能内置晶振
- 复位
  - 比如一个按钮
  - 或者用电容+电阻实现上电复位
  - 用来使程序重新从第一行开始运行

通常进行开发的时候会使用开发板

## 单片机命名举例

以 STC89C52 35I-DIP40 为例

- STC - 公司名
- 89 - 系列名
- C - 工作电压
  - C 表示 3.8-5.5V
  - LE 表示 2.4-3.4/3.6V
- 52 - RAM/ROM 的大小
  - 52 表示 512B RAM + 8KB ROM
- 35 - 工作频率
  - 35 表示最高 35MHz
- I - 工作温度
  - I 表示工业级，-40 - 85°C
  - C 表示商业级，0 - 70°C
- DIP - 封装类型，也就是芯片的脚是怎么伸出来的
  - 其他类型比如 PDIP、LQFP、PLCC、PQFP
- 40 - 引脚数

## 管脚含义举例

- VCC - 电源正极
- GND - 电源负极
- XTAL - 时钟
- RST - 复位
- DIR - 方向/Direction
- CR - 使能/Chip Enablement

## 软件工具

- Altium Designer
  - 用来画原理图
- Keil
  - 代码编辑
  - 内置很多单片机的细节
  - 可以辅助进行依赖管理，添加 C/C++头文件
  - 根据系统主频生成延时代码
    - 单片机没有`sleep`函数，需要在主程序中使用`nop`配合晶振主频实现等待
    - 或者使用定时器+中断系统

## 电阻标记

最后一个数字是指数，前面的数字是基数。以下是一些例子：

- `102`，意为`10 * 10^2`，也就是`1000`
- `473`，意为`47 * 10^3`，也就是`47000`
- `1001`，意为`100 * 10^1`，也就是`1000`

## 代码相关的知识点

- 单片机通常使用寄存器实现 IO
  - 通常要引入对应的头文件实现寄存器和变量的绑定
  - 这些寄存器被称为 _特殊功能寄存器_ C 语言有关键字 `sfr` 表示特殊功能寄存器
  - `sfr XXX = 0x11`意为变量`XXX`会绑定`0x11`这个地址。向`XXX`赋值等于向地址`0x11`赋值
- 程序执行完毕之后会重新从头开始执行
  - 也就是说 main 函数会被重复执行
  - 可以写一个死循环让程序继续执行，比如`while (1);`
- 单片机里面的 int 是 16 位的，而 PC 通常是 32 位
  - short 也是 16 位
  - long 是 32 位
- 单片机上电时，所有 IO 都是高电平
- 去抖动
  - 按下按键时可能会有 5-10ms 的抖动
  - 按键稳定持续时间大约为 50-200ms
  - 软件消抖：有操作时 delay 20ms 再判断一次
- 利用人眼视觉暂留，可以实现动态数码管显示
  - 不过由于数码管的消影问题，通常会在显示一个数码管之后，延迟 1ms，然后把数据清零，保证上一个数码管的信号不会偷跑到下一个数码管
  - 也可以使用专用芯片实现数码管的扫描，以免消耗太多单片机的 CPU 时间
- 单片机的高电平驱动能力弱，低电平的驱动能力强
  - 因为高电平驱动受限于单片机的电压
  - 可以使用额外的电源提供更高的电压，可以使用数据缓冲器
- 使用单片机内置的定时器/计数器
  - 不同单片机的定时器/计数器的个数和使用方式不同
  - 可以基于中断系统实现定时任务
- 可位寻址
  - 表示可以给寄存器的某个位单独赋值，而不是给寄存器整体赋值
  - C 语言有关键字 `sbit` 表示特殊位
  - `sbit XXX = 0x11`表示把某个特殊位的地址绑定给变量`XXX`
  - 也可以用`sbit YYY = XXX^5`的方式指定`YYY`是`XXX`的第五位
  - `sbit`变量只能被赋值 0 或者 1。如果赋值其他值，都视为 1
- 程序通过串口下载到单片机
- 如果数据比较多，可以给变量添加`code`关键字，使其保存在 Flash/ROM 里面而不是 RAM
  - 这种方法保存的数据不能修改
  - 如果存储空间还是不够，考虑使用外部存储

## 定时器/计数器

- 定时器可以有多种工作模式
  - 以 STC89C52 为例
    - 模式 0 - 13 位计数器
    - 模式 1 - 16 位计数器
    - 模式 2 - 8 位自动重装模式
    - 模式 3 - 两个 8 位计数器
- 定时器可以使用晶振，也可以使用一个引脚作为输入

## 寄存器常用命名方式

- CON - controller
- T - timer
- I - interrupt
- E - enable
- P - priority
- S - serial
- A - all
- F - flag
- R - ready
- MOD - model, 模式
- L - low
- H - high
- P - power
- BUF - buffer

## 通信

常见通信接口：

- UART - 全双工，异步，点对点
- I2C - 半双工，同步，支持多设备
- SPI - 全双工，同步，支持多设备
- 1-Wire - 半双工，异步，支持多设备

- 异步：双方约定时钟频率，并使用相同的时钟频率
- 同步：使用一根线作为时钟线，比如每次上升沿采集一次数据

### 串口

- 成本低
- 易用
- 两个设备互相通信
- 51 单片机自带 UART (Universal Async Recv Transmitter/通用异步收发器)，可以实现串口通信
- 串口使用 DB9 接口
  - 可以使用转接线，转换为 USB，也有蓝牙串口芯片
- 常用的电压标准有三种
  - TTL 电平：5V 表示 1，0V 表示 0
  - RS232 电平：-3 - -15V 表示 1， 3 - 15V 表示 0
  - RS485 电平：两线压差 2 - 6V 表示 1，-2 - -6V 表示 0（差分信号）
- STC89C52 内置一个 UART， 有四种工作模式
  - 模式 0：同步移位寄存器
  - 模式 1：8 位 UART，波特率可变（常用）
  - 模式 2：9 位 UART，波特率固定
  - 模式 3：9 位 UART，波特率可变
- 串口参数
  - 波特率：串口通信的速率
  - 校验位：8 位 UART 每次发一个字节。9 位 UART 会在最后加一个校验位
  - 停止位：UART 有一个起始位和一个停止位。所以 8 位 UART 的一帧是 10 位，9 位 UART 的一帧是 11 位
- 发送完毕和接受完毕时都有中断事件

### I2C

- 有地址线和数据线
- 支持一个主机连接多个外部芯片
- 通过给芯片的地址线设置高电平/低电平，可以设置芯片的地址。通常是上电的时候就固定的
- 通信的时候，不论读写，都是先发地址信号选择芯片，然后发数据的读写请求

### 1-Wire

- 只需要一根通信数据线：DQ
  - 当然还有供电线
- 使用时间长度表示数据 0 或者 1
  - 主机把总线拉低 60-120us 表示发送 0
  - 主机把总线拉低 1-15us 表示发送 1

## 常见电机

- 直流电机
  - 可以正反转
- 步进电机
  - 精密控制绝对角度
  - 常用于 3D 打印机
- 舵机
  - 内部是直流电机
  - 控制相对角度
  - 可以用来控制小车转向
- 无刷电机
  - 转速快
  - 常见于无人机
  - 功率大
- 空心杯电机
  - 小功率无刷电机

其他注意事项：

- 电机通常需要大功率电路进行驱动
  - 通常要外接大功率器件
    - 单向驱动
    - 使用达灵顿管或 MOS 实现三极管开关
  - 或者 H 桥电路
    - 双向驱动
- 电机有电感，**记得保护电路**
- 使用 PWM 实现速度的控制
  - 不能用滑动变阻器实现速度控制，因为电流太大，会烧毁变阻器
  - PWM 适用于具有惯性的系统，实现用数字信号模拟模拟信号
  - 高级的单片机，比如 STM32，会自带硬件 PWM，避免占用 CPU 时间
