---
title: Linux Basic (part 6)
description: shell编程
tags:
  - shell
---

## 前言

本文是观看[此视频](https://www.bilibili.com/video/bv1ut411a7ro)时整理的笔记，只记录了我觉得有价值的内容，用来查阅而不是用来学习。不一定适合小白入门Linux。

本文中的Linux系统为CentOS，不同系统在一些细节上会有偏差

本文中的一些描述混合了我的奇妙理解，添加了一些云计算相关知识

有些内容与[大学的笔记](/academic/LinuxProgrammingEnvironment/)重复，建议先看大学的笔记

## Shell

### 概述

Linux通常用Bash，Unix通常用C-shell。大致相同，由细微区别。可以在`/etc/shells`查看支持的shell

shell脚本文件后缀为`.sh`

如果一个拥有`x`权限的文本文件的开头有类似`#!/bin/bash`的一行（称为bash bang），则表示使用`/bin/bash`解释执行此文件。如果没有这一行，有可能可以正常执行，但是使用expect的时候会出问题

执行方法：
- 给脚本文件赋予`x`权限，然后使用路径执行
- 使用bash命令执行

基本命令：
- tab命令补全
- `history`查看历史命令
  - 历史保存在`~/.bash_history`中，重启也不会消失，但是此文件的内容可能不是最新的，需要退出登录的时候写入此文件。可以使用`history -w`手动触发写入
  - `-c`清空历史，包括内存和文件中的历史。不建议使用。通常仅用于明文输入密码后清除痕迹
  - 默认记录1000条历史。可以在`/etc/profile`中修改`HISTSIZE`来修改。因为历史保存在硬盘中而不是内存中，所以可以改大一点
  - 上下箭头切换历史命令
  - `!n`调用第`n`条历史命令
  - `!!`重复上一条命令
  - `!`加字符串可以执行以此字符串开头的最近的命令
  - `!$`重复上一条命令的最后一个参数
- 重定向
  - 输出重定向
    - `>`覆盖文件
    - `>>`追加内容
    - 文件指示符：`0`表示标准输入stdin，`1`表示标准输出stdout，`2`表示标准错误流stderr
      - 使用文件指示符实现重定向：`2>`表示重定向标准错误流，`&1`表示引用标准输出
      - `command > file 2>&1`或`command &> file`把标准输出和错误输出都保存在同一个文件
        - `2>&1`中的`2`和`>`之间不能有空格，`>`和`&1`之间可以有空格
      - `command >> file 2>&1`或`command &>> file`把标准输出和错误输出都追加在同一个文件
  - 输入重定向
    - `<`，不常用

### 多命令与逻辑

- 顺序执行命令：使用`;`分割命令。命令之间没有逻辑联系，不论前一个命令是否成功，后一个命令都会执行。仅用来把多个命令放在同一行
- 逻辑与：`&&`。前一个命令正确执行时后一个命令才会执行
- 逻辑或：`||`。前一个命令执行失败时后一个命令才会执行
- `command1 && command2 || command3`相当于C语言的`command1 ? command2 : command3`

### echo

`echo [options] [content]`
- `-e`支持反斜线控制字符转换
- `-n`取消输出后行末的换行符

颜色：
- `\e[1;<color>`表示开始颜色输出
- `\e[0m`表示结束颜色输出
- `\e[1;31m abcd \e[0m`表示用红色输出`abcd`。其中`31m`为红色
- 支持设置背景颜色

### 特殊符号

> 关于`[]`和`{}`建议参考[大学的笔记](/academic/LinuxProgrammingEnvironment/4)

- `''`，单引号中的所有特殊符号，比如`$`和`` ` ``，都没有特殊含义
- `""`，双引号中仅`$`、`` ` ``、`\`保留特殊含义，分别是引用变量、调用命令、转义
- ` `` `，反引号中的内容会被作为命令执行。
- `$()`，执行括号中的命令，和` `` `有相同的效果，但是使用此格式看起来更方便
- `()`，在子shell中执行括号中的命令
- `{}`，其实是命令`{`和命令`}`，所以记得加空格。在当前shell执行括号中的命令。可以用于变量变形与替换。
  - 可以使用`pstree`查看进程树
- `[]`，其实是命令`[`和`]`，所以记得加空格。相当于命令`test`，用来逻辑判断
- `#`，注释
- `$`，调用变量的值，如`$name`就会得到`name`的值。
- `${}`调用变量的值，和`$`有相同的效果。`${name}`和`$name`的值相同
- `\`，转义
- `$(())`数学运算


### 变量和运算符

#### 概述

赋值：`<name>=<value>`，注意变量名和等号之间不能有空格，否则会视为命令

变量拼接：`name="$name"123`，或者`name=${name}123`

#### 变量分类

- 用户自定义变量
  - 不会在子shell中生效
- 环境变量
  - 建议环境变量名大写
  - 会在子shell中生效
- 位置参数变量
  - `$n`，`n`为数字，`$0`表示命令本身，`$1`-`$9`表示第一个到第九个参数，十以上需要用大括号`${10}`
  - `$*`表示所有参数，且把所有参数视为整体
  - `$@`表示所有参数，但是把每个参数区分对待（相当于一个数组，用于循环语句）
  - `$#`表示参数个数（不包含命令本身）
- 预定义变量
  - `$?`上一条命令的返回值。0表示上一条命令正常执行
  - `$$`当前进程的PID
  - `$!`后台运行的最后一个进程的PID

#### 相关命令

- `set [options]`
  - `-u`如果设定此选项，调用未声明变量时会报错（shell默认行为是把未定义的变量视为空字符串）
    - 使用`+u`取消此选项
  - `-x`如果设定此选项，命令执行之前会把命令先输出一次
    - 使用`+x`取消此选项
  - 直接使用`set`命令可以查询系统中所有变量，包括用户自定义变量和环境变量（有些自定义变量和环境变量看不到），还有自定义函数
- `env`查看环境变量，无法查看用户自定义变量（有些环境变量看不到）
- `unset <var>`删除变量，可以删除环境变量
- `export <var>=<value>`或`export <var>`设置环境变量
  - 其实是使用了`declare -x`
- `read [options] [var]`提示用户输入
  - `-p <msg>`显示提示信息
  - `-t <second>`等待时间
  - `-n <count>`字符数。用户不需要输入换行符
  - `-s`隐藏输入的数据
  - 如果不提供变量名，则会保存在`REPLY`变量中
  - 如果仅提供一个变量名，则把整行放到变量中
  - 如果提供多个变量名，则把输入行拆分，一个一个进行赋值
- `declare [+|-][options] <var>`声明变量类型与数值运算
  - `-`给变量设置类型
  - `+`取消变量的类型
  - `a`数组
  - `i`整型
  - `r`只读。设置为只读后无法修改，无法删除，也无法取消只读。不推荐使用
  - `x`环境变量
  - `p`显示变量的类型
  - 数值计算：`declare -i c=$a+$b`
  - 数组赋值：`declare -a name[0]="123"`
    - 也可以直接`name[0]="123"`
    - 数组下标从0开始
    - 如果只写数组名，输出数组第一个元素。使用`name[*]`表示数组所有元素
- `expr`数值运算
  - `expr $a + $b`，注意运算符两侧必须有空格，因为运算符和数值都是`expr`命令的参数
- `let`数值运算并赋值
  - `let c=$a+$b`
- `$(())`或`$[]`进行数值运算（**推荐使用`$(())`**），对空格没有要求
  - 例：`$(($a+$b))`
  - 支持加减乘除、取模、逻辑运算、位运算
- `x=${y-<value>}`用来测试变量`y`
  - 如果变量`y`之前没有定义，则`x=value`
  - 如果变量`y`为空，则`x`为空
  - 如果变量`y`有值，则`x=$y`
  - 除了`-`，还有`:-`/`+`/`:+`/`=`/`:=`/`?`/`:?`

> 查询环境变量时需要使用`set`和`env`都查一下，因为有些环境变量只会出现在其中的一个里面。或者直接用`echo`输出一下

#### 环境变量相关文件

主要环境变量配置文件：

- `/etc/profile`
- `/etc/profile.d/*.sh`
- `~/.bash_profile`
- `~/.bashrc`
- `/etc/bashrc`

其中放在`/etc`下的文件对所有用户生效，放在用户家目录的仅对当前用户生效

> 可以使用`source <file>`或`. <file>`执行配置文件使配置生效

用户登录时：

1. `/etc/profile`
   1. `/etc/profile.d/*.sh`
      1. `/etc/profile.d/lang.sh`
         1. `/etc/sysconfig/i18n`
2. `~/.bash_profile`
   1. `~/.bashrc`
      1. `/etc/bashrc`

非登录情况下（比如使用`su`切换用户）：

1. `/etc/bashrc`
   1. `/etc/profile.d/*.sh`
      1. `/etc/profile.d/lang.sh`
         1. `/etc/sysconfig/i18n`

注销时生效的环境变量配置文件：`~/.bash_logout`，可以用来清除历史记录，备份某些数据等

其他环境相关文件（并不是脚本）：
- `~/.bash_history`显示命令历史
- `/etc/issue`在登录tty1-tty6这六个本地终端时会显示的欢迎信息（输入密码之前）
- `/etc/issue.net`修改ssh登录时显示的欢迎信息（输入密码之前）
- `/etc/motd`用户登录之后的欢迎信息，不论本地终端还是ssh终端（输入正确密码之后）

### 重要的环境变量

- `PATH`用来指定搜索命令的位置，不同的路径用`:`隔开
  - 添加路径：`PATH="$PATH":<path>`
- `PS1`定义命令提示符的输出格式
  - `\d`日期
  - `\H`完整主机名
  - `\h`简写主机名
  - `\t`24小时制时间
  - `\u`当前用户名
  - `\w`当前位置的完整路径
  - `\W`当前位置的路径最后一个目录
  - `\#`执行的第几个命令
  - `\$`提示符。root用户为`#`，普通用户为`$`
  - 比如可以设置输出格式为`[\u@\h \W]:\$`，就可以使用`PS1='[\u@\h \W]:\$'`，注意使用单引号
- `LANG`设置语系
  - `locale`查看当前系统的语系
  - `locale -a`查看本机支持的所有语系
  - 使用文件`/etc/sysconfig/i18n`设置系统默认语系
  - linux本机通常不支持中文，但是使用ssh客户端通常支持中文

### 定义快捷键

- `stty -a`查看所有快捷键
- `stty <keyword> <keys>`定义快捷键
  - `keyword`是一系列已经定义的指令，如`intr`，可以使用`stty`查看
  - `keys`直接手动输入即可，比如`^p`表示`Ctrl-P`

### 正则表达式（略）

正则表达式是用来匹配字符串的，通配符是用来匹配文件名的

### 文本处理

- `cut [options] <file>`列提取命令
  - `-f <num>`提取第几列。如果要指定多列，可以使用`,`隔开
  - `-d <delimiter>`指定分隔符（默认为tab）
  - `-c <range>`指定字符范围
- `printf`格式化输出
- `awk`复杂文本处理
- `sed`流处理
- `sort`排序
- `uniq`去重，相当于`sort -u`
- `wc`统计

### 条件判断（略）

### 控制流（略）

### 退出程序

`exit [return]`退出并返回`return`。默认返回0



